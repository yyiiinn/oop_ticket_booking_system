<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Event Manager | View Dashboard</title>

    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />

    <!-- Include Bootstrap -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <!-- Optional theme -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <style>
      .container {
        color: #404040;
      }

      .dashboard {
        border: 2px solid #616161;
        padding: 15px;
      }

      .total_tickets {
        margin-right: 20px;
      }

      @media (max-width: 767px) {
        .total_tickets {
          margin-bottom: 23px;
        }
      }

      .sign-out-button {
        color: #141b4d;
        /* Text color */
        border: 3px solid #141b4d;
        /* Add border here */
        padding: 5px 20px;
        margin-left: 20px;
        /* Spacing from the navbar links */
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, border-color 0.3s;
      }

      .sign-out-button:hover {
        color: #141b4d;
        border: 3px solid #141b4d;
      }
    </style>
  </head>

  <body>
    <div id="app" v-cloak>
      <div class="full-screen-container">
        <navbar-component active-link="dashboard"></navbar-component>

        <div class="container pt-5">
          <h2 class="text-center mb-4">Dashboard (Sales & Statistics)</h2>
          <p v-if="selectedEventName != ''" class="text-center text-secondary fs-4">For {{selectedEventName}}</p>

          <div class="d-flex justify-content-between mt-5 mb-3">
            <div class="form-group mb-3 dropdown-field">
              <select
                v-model="selectedEventId"
                @change="selectedEventData"
                class="form-select border-0 shadow-sm px-4 field"
                style="width: 300px"
              >
                <option value="" disabled selected>{{ defaultDropdownText }}</option>
                <option
                  v-for="event in events"
                  :key="event.id"
                  :value="event.id"
                >
                  {{ event.name }}
                </option>
              </select>
            </div>
            <button
              @click="exportDashboardToExcel"
              class="btn btn-primary font-weight-bold"
              type="button"
              title="Export"
              style="width: 100px; height: 50px"
            >
              Export
            </button>
          </div>

          <div class="row">
            <!-- Display Total No. of Tickets Sold -->
            <div class="col-md dashboard total_tickets text-center">
              <h2 class="fs-1">{{totalTicketsSold}}</h2>
              <p><strong>Total No. of Tickets Sold</strong></p>
            </div>
            <!-- Display Overall Revenue -->
            <div class="col-md dashboard text-center">
              <h2 class="fs-1">{{totalRevenue}}</h2>
              <p><strong>Total Revenue</strong></p>
            </div>
          </div>

          <div class="row mt-4">
            <!-- Display Customer Attendance -->
            <div class="col-md dashboard text-center">
              <h2 class="fs-1">{{customerAttendance}}</h2>
              <p><strong>Customer Attendance</strong></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- include axios.js -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- include Vue.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.21/vue.global.min.js"></script>

    <script type="module">
      import NavBarComponent from "/js/navbar/EventManNavBarComponent.js";

      const app = Vue.createApp({
        data() {
          return {
            totalTicketsSold: 0,
            totalRevenue: 0,
            customerAttendance: 0,
            selectedEventId: 0,
            selectedEventName: '',
            events: [], // Example event names
            defaultDropdownText: "Event Name",
          };
        },
        /*
      watch: {
        selectedEventName(newValue, oldValue) {
          this.fetchEventData(newValue);
        }
      },
      */
        mounted() {
          this.fetchEvents();
        },
        methods: {
          fetchEvents() {
            axios
              .get("http://localhost:8080/api/allEventsForDashboard")
              .then((response) => {
                this.events = response.data;
              })
              .catch((error) => {
                console.error("Error fetching events", error);
              });
          },
          selectedEventData() {
            const selectedEvent = this.events.find(event => event.id === this.selectedEventId);
            if (selectedEvent) {
                this.selectedEventName = selectedEvent.name; 
            }

            axios
              .get(
                "http://localhost:8080/api/manager/ViewDashboard/ticketSold/" +
                  this.selectedEventId
              )
              .then((response) => {
                // Handle successful response
                this.totalTicketsSold = response.data;
              })
              .catch((error) => {
                // Handle error
                this.totalTicketsSold = 0;
                console.error("Error fetching events:", error);
              });

            axios
              .get(
                "http://localhost:8080/api/manager/ViewDashboard/customerAttendance/Redeemed/" +
                  this.selectedEventId
              )
              .then((response) => {
                // Handle successful response
                this.customerAttendance = response.data;
              })
              .catch((error) => {
                // Handle error
                this.customerAttendance = 0;
                // console.error("Error fetching events:", error);
              });

            axios
              .get(
                "http://localhost:8080/api/manager/ViewDashboard/revenueGenerated/Booked/" +
                  this.selectedEventId
              )
              .then((response) => {
                this.totalRevenue = response.data;
              })
              .catch((error) => {
                this.totalRevenue = 0;
                console.error("Error fetching events:", error);
              });
          },
          exportDashboardToExcel() {
            let url;
            let fileName;

            if (this.selectedEventId) {
              // for selected event
              url = `http://localhost:8080/export/dashboard-data/excel?eventId=${this.selectedEventId}`;
              fileName = `${this.selectedEventName.replace(/[\W_]+/g, "_")}_DashboardData.xlsx`;
            } else {
              // for all events
              url = "http://localhost:8080/export/dashboard-data/excel";
              fileName = "All_Events_DashboardData.xlsx";
            }

            axios({
              url: url,
              method: 'GET',
              responseType: 'blob',
            }).then(response => {
              const downloadUrl = window.URL.createObjectURL(new Blob([response.data]));
              const link = document.createElement('a');
              link.href = downloadUrl;
              link.setAttribute('download', fileName); 
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link); 
            }).catch(error => {
              console.error("Error exporting data:", error);
            });
          }
        },
      });
      app.component("navbar-component", NavBarComponent);
      app.mount("#app");
    </script>
  </body>
</html>
